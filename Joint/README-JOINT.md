# 计算机网络原理与计算机组成原理联合实验

## 实验要求

本联合实验要求在 ThinRouter 平台上实现一个 CPU + 路由器，路由器要求支持 RIP 协议和转发。

## 实验平台

ThinRouter 的样例工程在 [z4yx/thinpad_top#thinrouter.1](https://github.com/z4yx/thinpad_top/branches/thinrouter.1) ，克隆后就可以得到一个样例工程，引脚约束和基本的 testbench 已经提供好，KSZ 8795 芯片也会通过 SPI 协议自动配置。

## 实验指导

### 第一阶段：学习 AXI-Stream 协议、 RGMII 接口和基本的网络知识

#### 学习 AXI-Stream 协议

在本次实验中，我们已经把以太网 MAC 配置好，以太网帧的内容会通过 AXI-Stream 协议与其余逻辑进行交互。通过在 Vivado 中运行 testbench，可以找到接受到的以太网帧对应在 AXI-Stream 上的波形，把它和 testbench 中编写的以太网帧进行比较。

#### 学习 RGMII 接口

实际在 FPGA 芯片 和以太网 PHY 芯片之间通信的是 RGMII 接口，请观察仿真中 RGMII 的波形，和上面 AXI-Stream 的进行比较，应该可以找到一些相同点和不同点。

#### 学习基础的网络知识

了解 IP 和 ARP 协议的基本功能和转发的概念，理解 KSZ8795 的 VLAN 配置，然后自己用 Linux 系统搭建一个网络，用 Linux 自带的转发功能，学会用 tcpdump 和 Wireshark 进行抓包分析。

了解转发的概念以后，可以基于 HAL 编写一个固定转发方式的路由器，比如只有 A B C三个结点，B 只处理 A 发给 C 和 C 发给 A的，检验 ping 是否成功。

阅读 testbench 中提供的样例以太网帧，估计一下路由器应该做出如何的反应。

#### 尝试在仿真中实现 Loopback

Loopback 就是环回的意思，在 testbench 中，仿真代码会向 RGMII 不断发以太网帧，你要做的就是原样地发回去。你需要理解 AXI-Stream 接口的使用方式，主要是信号的握手和数据的传输过程。建议用一个单独的时钟域编写你的环回逻辑，通过一个异步 FIFO 把 MAC 的 125M 和单独的时钟隔开，这样你的逻辑有更多的时序自由度。

如果 Loopback 实现正确，你应该可以在仿真中看到 TX 的 RGMII 上有波形，并且它的内容和 RX 的内容是一样的。进一步，你可以尝试修改测试的以太网帧的内容，让它接受到不同长度的内容，并观察在 FCS 正确与错误时的表现。

如果在实现上遇到了困难，可以打开 IP 的 Example Design，里面有一个 Loopback 的实现，但比较复杂，不容易理解。

## 实验验收基础要求

![](topology_joint.png)


测试方法（满足部分即可拿到满分，超过满分部分舍去）：

1. 连通性（10%）：PC1-4 两两之间可以互相 `ping` 通
2. 单链接单工：在 PC1 运行 `iperf3 -s`，在 PC2 运行 `iperf3 -c 192.168.5.3`，默认参数运行，带宽不低于 70Mbps （15%），不低于 90Mbps（20%）
3. 双链接单工：在 PC2 运行 `iperf3 -s`，在 PC3 运行 `iperf3 -s`，同时在 PC1 运行 `iperf3 -c 192.168.6.3` 和在 PC4 运行 `iperf3 -c 192.168.7.3`，默认参数运行，带宽之和不低于 100 Mbps（10%），不低于 150Mbps （15%），不低于 180Mbps（20%）
4. 双链接双工：在 PC1-4 运行 `iperf3 -s`，同时在 PC1 运行 `iperf3 -c 192.168.6.3` ，在 PC1 运行 `iperf3 -c 192.168.6.3` 在 PC2 运行 `iperf3 -c 192.168.5.3` 在 PC3 运行 `iperf3 -c 192.168.8.3` 在 PC4 运行 `iperf3 -c 192.168.7.3`，默认参数运行，带宽之和不低于 150 Mbps（20%），不低于 250Mbps （25%），不低于 350Mbps（30%）
5. 单链接单工小包：在 PC2 运行 `iperf3 -s`，在 PC1 运行 `iperf3 -c 192.168.6.3 -u -l 16 -t 5 -b 1G`，在 PC2 计算 0.00-5.00 秒总共的 `(Total Datagrams - Lost) / 5s` ，不低于 1K（5%），不低于 5K（10%），不低于 25K（15%），不低于 50K（20%），不低于 100K（30%）
6. 小规模路由表压力测试（10%）：在 R1 上额外配置 192.168.10.0/24 ~ 192.168.255.0/24 共 246 条新的路由，保证 RIP 协议运行的正确性
7. 中等规模路由表压力测试（15%）：在 R1 R2 R3 R4 上分别配置 10.1.0.0/24 ~ 10.2.255.0/24，10.3.0.0/24 ~ 10.4.255.0/24，10.5.0.0/24 ~ 10.6.255.0/24，10.7.0.0/24 ~ 10.8.255.0/24 共 2048 条新路由，保证 RIP 协议运行和转发功能的正确性
8. 较大规模路由表压力测试（20%）：在 R1 上配置 AS4538 的所有 IPv4 路由（约 5000 条），保证 RIP 协议运行和转发功能的正确性
9. 其他扩展功能：经助教和老师同意可以获得每项不高于 10% 的分数

在 `SetupJoint` 目录下还有用于测试以上各项的脚本 ，执行前需要执行 `./setup.sh` 以配置环境，然后在 tmux 之外运行 `./part[1-8].sh` 以测试各个阶段。此外，`./disable.sh` 会关闭 BIRD 的额外的路由表， `./restart.sh` 会重启 BIRD 。

测试流程：

1. 在 tmux 之外运行 ./setup.sh ，检查 eno1-4 是否分别出现在 R1-4 的 netns，如果不在就在 tmuc 之外再次运行 ./setup.sh 。
2. 在 tmux 之外按顺序运行 ./part{1,2,3,4,5}.sh 进行测试，每个 part 都可以多次运行。
3. 对于路由表的测试，可以运行 ./part{6,7,8}.sh 在 BIRD 中开启对应的路由表，用 ./disable.sh 关掉额外的路由表，用 ./restart.sh 重启 BIRD 。测试过程中，可以通过重启 BIRD 来保证上一阶段的路由表都已经过期。

注意事项：

1. tmux 使用方法网上可查，没有修改配置。
2. Shell 提示符中会显示当前的 netns 。
3. 部分脚本需要在 tmux 外运行。
